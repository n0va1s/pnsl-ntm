version: '3.8'

services:
    # 1. Serviço da Aplicação Laravel (PHP-FPM)
    laravel.app:
        build:
            context: . # Usa o Dockerfile na raiz
            dockerfile: Dockerfile
        image: laravel:latest # Nome da imagem final
        container_name: laravel_app
        restart: unless-stopped
        volumes:
            # Não mapeamos o código em produção para evitar sobreposições acidentais,
            # o código já está na imagem, mas você pode mapear os logs e storage
            - storage_data:/var/www/html/storage
        environment:
            # Variáveis de ambiente
            - APP_ENV=production
            - APP_DEBUG=false
            - DB_CONNECTION=mysql
            - DB_HOST=mysql.db # Nome do service do banco de dados
            - DB_PORT=3306
            - DB_DATABASE=${DB_DATABASE}
            - DB_USERNAME=${DB_USERNAME}
            - DB_PASSWORD=${DB_PASSWORD}
        networks:
            - laravel-network

    # 2. Serviço do Servidor Web (Nginx)
    nginx:
        image: nginx:stable-alpine
        container_name: laravel_nginx
        restart: unless-stopped
        ports:
            - "80:80" # Mapeia a porta 80 do host para a porta 80 do container
        volumes:
            - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro # Copia a configuração
            - .:/var/www/html:ro # Monta o código em modo somente leitura (read-only)
            - storage_data:/var/www/html/storage
        depends_on:
            - laravel.app # Nginx depende que a aplicação esteja rodando
        networks:
            - laravel-network

    # 3. Serviço do Banco de Dados (MySQL)
    mysql.db:
        image: mysql:8.0
        container_name: laravel_mysql
        restart: unless-stopped
        environment:
            MYSQL_DATABASE: ${DB_DATABASE}
            MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
            MYSQL_USER: ${DB_USERNAME}
            MYSQL_PASSWORD: ${DB_PASSWORD}
        volumes:
            - db_data:/var/lib/mysql # Persiste os dados do banco
        networks:
            - laravel-network

# Volumes para persistência de dados
volumes:
    db_data:
    storage_data:

# Rede interna para que os containers se comuniquem
networks:
    laravel-network:
        driver: bridge